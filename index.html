<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Simple App</title>
        <style>
            .pre-output {
                width: 100%;
                max-width: 600px;
                min-height: 200px;
                margin-top: 20px;
                padding: 15px;
                font-family: monospace;
                background-color: #f5f5f5;
                border: 1px solid #ccc;
                border-radius: 4px;
                white-space: pre-wrap;
                word-wrap: break-word;
                overflow-x: auto;
            }

            .button {
                padding: 10px 20px;
                font-size: 16px;
                cursor: pointer;
                background-color: #4caf50;
                color: white;
                border: none;
                border-radius: 4px;
            }

            .button:hover {
                background-color: #45a049;
            }
        </style>
    </head>
    <body>
        <h1>Simple App</h1>
        <!--<button onclick="makeLndRequest()">Getinfo LND Request</button>-->
        <button onclick="makeCoreLnRequest()">Getinfo Coreln</button>
        <button onclick="makeEclairRequest()">Getinfo Eclair Request</button>

        <button onclick="createCoreLnOffer()">Make Coreln Offer</button>
        <button onclick="payCoreLnOfferEclair()">
            Pay Coreln Offer from Eclair
        </button>
        <input type="text" id="offer" />
        <pre id="response" class="pre-output">Response will appear here...</pre>
        <script>
            const coreln = "https://localhost:9097/v1";
            const rune = "ZNfqnwDJFBBAJXCPK0mUHOd3c6IvUhWJG3jhj3tODAw9MQ==";

            const lnd = "https://localhost:9103/v1";
            const macaroon =
                "0201036c6e6402f801030a103b277295bf740c198c4b5260af40d1571201301a160a0761646472657373120472656164120577726974651a130a04696e666f120472656164120577726974651a170a08696e766f69636573120472656164120577726974651a210a086d616361726f6f6e120867656e6572617465120472656164120577726974651a160a076d657373616765120472656164120577726974651a170a086f6666636861696e120472656164120577726974651a160a076f6e636861696e120472656164120577726974651a140a057065657273120472656164120577726974651a180a067369676e6572120867656e6572617465120472656164000006200e2be9371719e4f0a9e60bffb2c5b15914775df53043e83099625a8a2e17e6e6";

            const eclair = "localhost:9100";
            const password = "test1234";

            const corsProxyUrl = "http://localhost:8080";
            // if seeing cors issues, first go to 'https://localhost:9097/' or 'https://localhost:9103/' and accept the risk, the post endpoints will work
            // setting will stay for as long as the same browser session is open

            // coreln API docs https://docs.corelightning.org/reference/get_list_methods_resource
            // lnd API docs https://lightning.engineering/api-docs/api/lnd/index.html
            // eclair API docs https://acinq.github.io/eclair/#introduction

            // make the coreln and eclair nodes pay each other via bolt12!
            // coreln BOLT12: https://docs.corelightning.org/reference/lightning-offer -- create offer
            // eclair BOLT12: https://acinq.github.io/eclair/#payoffer -- pay offer
            async function makeCoreLnRequest() {
                const responseElement = document.getElementById("response");

                responseElement.textContent = "Making request to coreln...";

                try {
                    const response = await fetch(
                        `${corsProxyUrl}/${coreln}/getinfo`,
                        {
                            method: "POST",
                            headers: {
                                Rune: rune,
                            },
                        },
                    );

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const data = await response.json();
                    responseElement.textContent =
                        "Response:\n" + JSON.stringify(data, null, 2);
                } catch (error) {
                    console.error("Error:", error);
                    responseElement.textContent = "Error: " + error.message;
                }
            }

            async function createCoreLnOffer() {
                const responseElement = document.getElementById("response");

                responseElement.textContent = "Making request to coreln...";

                try {
                    const response = await fetch(
                        `${corsProxyUrl}/${coreln}/offer`,
                        {
                            method: "POST",
                            headers: {
                                Rune: rune,
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                amount: 100000,
                                absolute_expiry: 1730262305,
                                description: "tabconf 2024",
                            }),
                        },
                    );

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const data = await response.json();
                    responseElement.textContent =
                        "Response:\n" + JSON.stringify(data, null, 2);
                } catch (error) {
                    console.error("Error:", error);
                    responseElement.textContent = "Error: " + error.message;
                }
            }

            async function payCoreLnOfferEclair() {
                const responseElement = document.getElementById("response");

                responseElement.textContent = "Making request to coreln...";
                const offer = document.getElementById("offer").value;
                const encodedCredentials = btoa(":" + password);

                try {
                    const formData = new FormData();
                    formData.append("offer", offer);
                    formData.append("amountMsat", "100000");
                    formData.append("blocking", "true");
                    formData.append("connectDirectly", "true");
                    const response = await fetch(
                        `${corsProxyUrl}/${eclair}/payoffer`,
                        {
                            method: "POST",
                            headers: {
                                Authorization: `Basic ${encodedCredentials}`,
                            },
                            body: formData,
                        },
                    );

                    if (!response.ok) {
                        console.log(response);
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const data = await response.json();
                    responseElement.textContent =
                        "Response:\n" + JSON.stringify(data, null, 2);
                } catch (error) {
                    console.error("Error:", error);
                    responseElement.textContent = "Error: " + error.message;
                }
            }

            async function makeEclairRequest() {
                const responseElement = document.getElementById("response");

                responseElement.textContent = "Making request to eclair...";
                const encodedCredentials = btoa(":" + password);
                console.log(encodedCredentials);
                try {
                    const response = await fetch(
                        `${corsProxyUrl}/${eclair}/getinfo`,
                        {
                            method: "POST",
                            headers: {
                                Authorization: `Basic ${encodedCredentials}`,
                            },
                        },
                    );

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const data = await response.json();
                    responseElement.textContent =
                        "Response:\n" + JSON.stringify(data, null, 2);
                } catch (error) {
                    console.error("Error:", error);
                    responseElement.textContent = "Error: " + error.message;
                }
            }

            async function makeLndRequest() {
                const responseElement = document.getElementById("response");
                responseElement.textContent = "Making request to lnd...";

                try {
                    const response = await fetch(
                        `${corsProxyUrl}/${lnd}/getinfo`,
                        {
                            method: "GET",
                            headers: {
                                "Grpc-Metadata-macaroon": macaroon,
                                "X-Requested-With": "XMLHttpRequest",
                            },
                        },
                    );

                    if (!response.ok) {
                        throw new Error(
                            `HTTP error! status: ${response.status}`,
                        );
                    }

                    const data = await response.json();
                    responseElement.textContent =
                        "Response:\n" + JSON.stringify(data, null, 2);
                } catch (error) {
                    console.error("Error:", error);
                    responseElement.textContent = "Error: " + error.message;
                }
            }
        </script>
    </body>
</html>
